#!/bin/sh -e

# cd $(mktemp -d --suffix="-klanginst")

URL_REPO="https://github.com/C4F3Z1N/OpsTechIT-Lockers.Klang"
URL_INSTALLER="${URL_REPO}/raw/refactoring/klanginst"
URL_PACKED="${URL_REPO}/archive/refactoring.zip"
URL_VENV="https://bootstrap.pypa.io/virtualenv/2.7/virtualenv.pyz"


# colored_output() {
# 	local GREEN=92
# 	local MAGENTA=95
# 	local RED=91
# 	local YELLOW=93
# 	local NONE=0

# 	local TEXT="${@}"

# 	# case $()

# 	# echo -e ""
# }


usage() {
	echo "Usage: "
	echo "wget -qO - \"${URL_INSTALLER}\" | \${SHELL}"
}


no_sudo() {
	if [ $(whoami) == "root" ]; then
		echo "[ERROR] Please DO NOT run this script as root/su/sudo." 1>&2
		exit 1
	fi
}


mkenvdir() {
	local DIR="$(mktemp -u)-pyenv"
	local VENV="$(mktemp -u)"

	download ${URL_VENV} ${VENV}

	python ${VENV} -q ${DIR}
	echo ${DIR}
}


download() {
	local SOURCE="${1}"
	local DEST="${2}"

	# echo "[INFO] Downloading:"
	# echo ${SOURCE}
	curl -Lk# ${SOURCE} -o ${DEST}
}

extract() {
	local SOURCE="${1}"
	local DEST="${2}"
	local TMPDIR="$(mktemp -d)"

	TOPLEVEL=$(
		unzip -l ${SOURCE} \
			| awk '{print $4}' \
			| grep -o ".*/" \
			| sort -u \
			| head -n 1 \
			| xargs basename \
	)

	echo "DEST: ${DEST}"

	ln -fsv ${DEST} "${TMPDIR}/${TOPLEVEL}"
	unzip -o ${SOURCE} -d ${TMPDIR}
	# rm -frv ${TMPDIR}
}


fix_dependencies() {
	echo "[INFO] Checking dependencies:"
	pip install \
		--no-python-version-warning \
		-r requirements.txt \
		| grep -vi "satisfied"
}


main() {
	set -x
	cd "$(mkenvdir)"
	PACKED="$(mktemp -u)"
	download ${URL_PACKED} ${PACKED}
	extract ${PACKED} ${PWD}
}

main
source ${PWD}/activate
fix_dependencies
